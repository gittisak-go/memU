"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 4: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‚Äî ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP

‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
    pip install memu-py
    export OPENAI_API_KEY=your_api_key
    python examples/community/04_community_economic.py
"""

import asyncio
import os
import sys
import tempfile

sys.path.insert(0, os.path.abspath("src"))
from memu.app import MemoryService

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô = (
    "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏° ‡∏Å.‡∏û. 2025\n"
    "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å 12,500 ‡∏ö‡∏≤‡∏ó ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ 3,200 ‡∏ö‡∏≤‡∏ó "
    "OTOP ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å 8,500 ‡∏ö‡∏≤‡∏ó ‡∏ú‡πâ‡∏≤‡∏ó‡∏≠ 15,000 ‡∏ö‡∏≤‡∏ó ‡∏£‡∏ß‡∏° 39,200 ‡∏ö‡∏≤‡∏ó\n"
    "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ 1,500 ‡∏ö‡∏≤‡∏ó ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö 5,200 ‡∏ö‡∏≤‡∏ó ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ 3,000 ‡∏ö‡∏≤‡∏ó ‡∏£‡∏ß‡∏° 9,700 ‡∏ö‡∏≤‡∏ó\n"
    "‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: 29,500 ‡∏ö‡∏≤‡∏ó ‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏° 245,300 ‡∏ö‡∏≤‡∏ó\n"
    "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°: ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏£‡∏±‡∏ï‡∏ô‡∏≤ (‡∏Ñ‡πâ‡∏≤‡∏á 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏∞‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏®‡∏∏‡∏Å‡∏£‡πå), "
    "‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏Ñ‡πâ‡∏≤‡∏á 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ), ‡∏ô‡∏≤‡∏á‡∏°‡∏≤‡∏•‡∏µ (‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ú‡∏±‡∏ô ‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢)"
)

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = (
    "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°\n"
    "1. ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏Å‡∏∞‡∏õ‡∏¥‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏ö‡∏£‡∏≤‡∏ì: ‡∏™‡∏ï‡πá‡∏≠‡∏Å 45 ‡∏Ç‡∏ß‡∏î ‡∏£‡∏≤‡∏Ñ‡∏≤ 120 ‡∏ö‡∏≤‡∏ó ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô 65 ‡∏ö‡∏≤‡∏ó "
    "‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß 70 ‡∏Ç‡∏ß‡∏î ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏≠‡∏¢.\n"
    "2. ‡∏ú‡πâ‡∏≤‡∏ó‡∏≠‡∏°‡∏∑‡∏≠‡∏•‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ: ‡∏™‡∏ï‡πá‡∏≠‡∏Å 8 ‡∏ú‡∏∑‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤ 850 ‡∏ö‡∏≤‡∏ó ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô 380 ‡∏ö‡∏≤‡∏ó "
    "‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß 18 ‡∏ú‡∏∑‡∏ô ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°\n"
    "3. ‡∏™‡∏ö‡∏π‡πà‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ï‡∏∞‡πÑ‡∏Ñ‡∏£‡πâ: ‡∏™‡∏ï‡πá‡∏≠‡∏Å 120 ‡∏Å‡πâ‡∏≠‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤ 45 ‡∏ö‡∏≤‡∏ó ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô 18 ‡∏ö‡∏≤‡∏ó "
    "‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß 30 ‡∏Å‡πâ‡∏≠‡∏ô ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÉ‡∏´‡∏°‡πà"
)


async def ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•(service: MemoryService) -> None:
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô"""
    print("\nüí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô...")
    for ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ in [("‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô", ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô), ("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)]:
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False, encoding="utf-8") as f:
            f.write(‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
            path = f.name
        try:
            result = await service.memorize(resource_url=path, modality="document",
                                            where={"user_id": "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°"})
            print(f"  ‚úì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•{‡∏ä‡∏∑‡πà‡∏≠} ‚Äî {len(result.get('items', []))} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        finally:
            os.unlink(path)


async def ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service: MemoryService) -> None:
    """‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"""
    print("\nüîç ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° = [
        "‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£? ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?",
        "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô?",
        "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î? ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£?",
    ]
    where = {"user_id": "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°"}
    for ‡∏ñ‡∏≤‡∏° in ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
        print(f"\n‚ùì {‡∏ñ‡∏≤‡∏°}")
        ‡∏ú‡∏• = await service.retrieve(queries=[{"role": "user", "content": ‡∏ñ‡∏≤‡∏°}], where=where)
        for i, item in enumerate(‡∏ú‡∏•.get("items", [])[:2], 1):
            print(f"  {i}. {item.get('summary', '')[:110]}")
        if not ‡∏ú‡∏•.get("items"):
            print("  ‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")


async def ‡∏´‡∏•‡∏±‡∏Å() -> None:
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô"""
    print("=" * 55)
    print("üåæ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‚Äî ‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏•‡∏∞ OTOP")
    print("=" * 55)
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OPENAI_API_KEY ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        return
    service = MemoryService(
        llm_profiles={"default": {"api_key": api_key, "chat_model": "gpt-4o-mini"}},
        memorize_config={"memory_categories": [
            {"name": "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢", "description": "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°"},
            {"name": "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "description": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"},
            {"name": "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "description": "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢"},
        ]},
    )
    print("  ‚úì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    await ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•(service)
    await ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service)
    print("\n‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå")


if __name__ == "__main__":
    asyncio.run(‡∏´‡∏•‡∏±‡∏Å())
