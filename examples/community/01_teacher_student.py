"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•

‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
    pip install memu-py
    export OPENAI_API_KEY=your_api_key
    python examples/community/01_teacher_student.py
"""

import asyncio
import os
import sys
import tempfile

sys.path.insert(0, os.path.abspath("src"))
from memu.app import MemoryService

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏™‡∏°‡∏°‡∏ï‡∏¥) ‚Äî ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°
‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô = [
    ("‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏¥‡∏ô", "‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á: ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏®‡∏¥‡∏•‡∏õ‡∏∞ ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô: ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡πÑ‡∏î‡πâ‡∏ä‡πâ‡∏≤ "
               "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏Ñ‡∏ì‡∏¥‡∏ï 92 ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 85 ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 62 ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ‡∏Ç‡∏¢‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Ç‡∏µ‡πâ‡∏≠‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤‡∏ñ‡∏≤‡∏°"),
    ("‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", "‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á: ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô: ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô "
               "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏Ñ‡∏ì‡∏¥‡∏ï 70 ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 80 ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 95 ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ‡∏ä‡πà‡∏≤‡∏á‡∏û‡∏π‡∏î ‡∏ä‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô"),
    ("‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡πâ‡∏≤‡∏¢", "‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á: ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô: ‡∏Å‡∏•‡∏±‡∏ß‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏≠‡πà‡∏≠‡∏ô "
                "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏Ñ‡∏ì‡∏¥‡∏ï 75 ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 96 ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 78 ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏Ç‡∏£‡∏∂‡∏° ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤"),
]


async def ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô(service: MemoryService) -> None:
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ modality='document'"""
    print("\nüìö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...")
    for ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ in ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False, encoding="utf-8") as f:
            f.write(‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
            path = f.name
        try:
            result = await service.memorize(resource_url=path, modality="document",
                                            where={"user_id": ‡∏ä‡∏∑‡πà‡∏≠})
            print(f"  ‚úì {‡∏ä‡∏∑‡πà‡∏≠} ‚Äî {len(result.get('items', []))} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        finally:
            os.unlink(path)


async def ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service: MemoryService) -> None:
    """‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"""
    print("\nüîç ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° = [
        ("‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏¥‡∏ô‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏î‡∏ö‡πâ‡∏≤‡∏á?", "‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏¥‡∏ô"),
        ("‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", None),
    ]
    for ‡∏ñ‡∏≤‡∏°, user in ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
        where = {"user_id": user} if user else None
        print(f"\n‚ùì {‡∏ñ‡∏≤‡∏°}")
        ‡∏ú‡∏• = await service.retrieve(queries=[{"role": "user", "content": ‡∏ñ‡∏≤‡∏°}], where=where)
        for i, item in enumerate(‡∏ú‡∏•.get("items", [])[:2], 1):
            print(f"  {i}. {item.get('summary', '')[:110]}")
        if not ‡∏ú‡∏•.get("items"):
            print("  ‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")


async def ‡∏´‡∏•‡∏±‡∏Å() -> None:
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏à‡∏î‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"""
    print("=" * 55)
    print("üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π ‚Äî ‡∏à‡∏î‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•")
    print("=" * 55)
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OPENAI_API_KEY ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        return
    service = MemoryService(
        llm_profiles={"default": {"api_key": api_key, "chat_model": "gpt-4o-mini"}},
        memorize_config={"memory_categories": [
            {"name": "‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á", "description": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á"},
            {"name": "‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô", "description": "‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"},
            {"name": "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "description": "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö"},
            {"name": "‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°", "description": "‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"},
        ]},
    )
    print("  ‚úì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    await ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô(service)
    await ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service)
    print("\n‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå")


if __name__ == "__main__":
    asyncio.run(‡∏´‡∏•‡∏±‡∏Å())
