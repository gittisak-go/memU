"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 3: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥

‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
    pip install memu-py
    export OPENAI_API_KEY=your_api_key
    python examples/community/03_family_assistant.py
"""

import asyncio
import os
import sys
import tempfile

sys.path.insert(0, os.path.abspath("src"))
from memu.app import MemoryService

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (‡∏™‡∏°‡∏°‡∏ï‡∏¥) ‚Äî ‡πÅ‡∏¢‡∏Å user_id ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å = [
    ("‡∏û‡πà‡∏≠‡∏™‡∏°‡∏ä‡∏≤‡∏¢",
     "‡∏û‡πà‡∏≠‡∏™‡∏°‡∏ä‡∏≤‡∏¢ 45 ‡∏õ‡∏µ ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡∏à-‡∏® ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 8-18‡∏ô. ‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏û‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© "
     "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: 12 ‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô ‡∏ä‡∏≠‡∏ö: ‡∏î‡∏π‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏• ‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡πÄ‡∏ú‡πá‡∏î "
     "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ñ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° ‡∏ã‡πà‡∏≠‡∏°‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥"),
    ("‡πÅ‡∏°‡πà‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á",
     "‡πÅ‡∏°‡πà‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á 42 ‡∏õ‡∏µ ‡∏Ñ‡∏£‡∏π ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡∏à-‡∏® ‡∏™‡∏≠‡∏ô 7:30-16:30 ‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£-‡∏û‡∏§‡∏´‡∏±‡∏™‡∏™‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÑ‡∏õ‡∏ß‡∏±‡∏î "
     "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: 3 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° ‡∏ä‡∏≠‡∏ö: ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏î‡∏π‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ "
     "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏°‡πà ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°‡∏•‡∏π‡∏Å‡∏™‡∏≤‡∏ß"),
    ("‡∏•‡∏π‡∏Å‡∏ä‡∏≤‡∏¢‡∏ò‡∏µ‡∏£‡πå",
     "‡∏•‡∏π‡∏Å‡∏ä‡∏≤‡∏¢‡∏ò‡∏µ‡∏£‡πå 15 ‡∏õ‡∏µ ‡∏°.3 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡∏à-‡∏® ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 7-16‡∏ô. ‡πÄ‡∏™‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ã‡πâ‡∏≠‡∏°‡∏ö‡∏≤‡∏™ "
     "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: 25 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° ‡∏ä‡∏≠‡∏ö: ‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏• ‡πÄ‡∏û‡∏•‡∏á K-pop ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏° "
     "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ô‡∏µ‡πâ ‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤"),
    ("‡∏•‡∏π‡∏Å‡∏™‡∏≤‡∏ß‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏≤",
     "‡∏•‡∏π‡∏Å‡∏™‡∏≤‡∏ß‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏≤ 10 ‡∏õ‡∏µ ‡∏õ.4 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡∏à-‡∏® ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 7:30-15:30 ‡∏û‡∏∏‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡πÇ‡∏ô ‡πÄ‡∏™‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© "
     "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: 8 ‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô ‡∏ä‡∏≠‡∏ö: ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡πÇ‡∏ô ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô ‡∏Å‡∏¥‡∏ô‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏° "
     "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡πÇ‡∏ô‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå"),
]


async def ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß(service: MemoryService) -> None:
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô"""
    print("\nüë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß...")
    for user_id, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ in ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False, encoding="utf-8") as f:
            f.write(‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
            path = f.name
        try:
            result = await service.memorize(resource_url=path, modality="document",
                                            where={"user_id": user_id})
            print(f"  ‚úì {user_id} ‚Äî {len(result.get('items', []))} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        finally:
            os.unlink(path)


async def ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service: MemoryService) -> None:
    """‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß"""
    print("\nüîç ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° = [
        ("‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏∏‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ?", None),
        ("‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô?", None),
    ]
    for ‡∏ñ‡∏≤‡∏°, user in ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
        where = {"user_id": user} if user else None
        print(f"\n‚ùì {‡∏ñ‡∏≤‡∏°}")
        ‡∏ú‡∏• = await service.retrieve(queries=[{"role": "user", "content": ‡∏ñ‡∏≤‡∏°}], where=where)
        for i, item in enumerate(‡∏ú‡∏•.get("items", [])[:2], 1):
            print(f"  {i}. {item.get('summary', '')[:110]}")
        if not ‡∏ú‡∏•.get("items"):
            print("  ‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")


async def ‡∏´‡∏•‡∏±‡∏Å() -> None:
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß"""
    print("=" * 55)
    print("üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö")
    print("=" * 55)
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OPENAI_API_KEY ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        return
    service = MemoryService(
        llm_profiles={"default": {"api_key": api_key, "chat_model": "gpt-4o-mini"}},
        memorize_config={"memory_categories": [
            {"name": "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤", "description": "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå"},
            {"name": "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î", "description": "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß"},
            {"name": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö", "description": "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô"},
            {"name": "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥", "description": "‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"},
        ]},
    )
    print("  ‚úì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    await ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß(service)
    await ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service)
    print("\n‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå")


if __name__ == "__main__":
    asyncio.run(‡∏´‡∏•‡∏±‡∏Å())
