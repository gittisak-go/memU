"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ‚Äî ‡∏¢‡∏≤ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥

‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
    pip install memu-py
    export OPENAI_API_KEY=your_api_key
    python examples/community/02_elderly_care.py
"""

import asyncio
import os
import sys
import tempfile

sys.path.insert(0, os.path.abspath("src"))
from memu.app import MemoryService

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• = {
    "‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå": (
        "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏≠‡∏≤‡∏¢‡∏∏ 72 ‡∏õ‡∏µ\n"
        "‡∏¢‡∏≤: Amlodipine 5mg (‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£), Metformin 500mg (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£), "
        "Aspirin 81mg (‡πÄ‡∏ä‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£), ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô D3 (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á)\n"
        "‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠: ‡∏ô‡∏û.‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° 15 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2025 ‡πÄ‡∏ß‡∏•‡∏≤ 10:00\n"
        "‡∏ô‡∏±‡∏î‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°: ‡∏ó‡∏û.‡∏™‡∏∏‡∏†‡∏≤ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏∏‡∏Ç‡πÉ‡∏à 28 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2025 ‡πÄ‡∏ß‡∏•‡∏≤ 14:00\n"
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏ß‡∏¥‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (5 ‡∏Å.‡∏û.) ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô; ‡∏õ‡∏ß‡∏î‡πÄ‡∏Ç‡πà‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (10 ‡∏Å.‡∏û.)"
    ),
    "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏£": (
        "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤‡∏¢ ‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏£ ‡∏≠‡∏≤‡∏¢‡∏∏ 68 ‡∏õ‡∏µ\n"
        "‡∏¢‡∏≤: Levothyroxine 50mcg (‡πÄ‡∏ä‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 30 ‡∏ô‡∏≤‡∏ó‡∏µ), ‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°+‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô D (‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)\n"
        "‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠: ‡∏û‡∏ç.‡∏≠‡∏£‡∏∏‡∏ì‡∏µ ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏≤‡∏°‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πà‡∏≠‡∏°‡πÑ‡∏£‡πâ‡∏ó‡πà‡∏≠ 20 ‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2025 ‡πÄ‡∏ß‡∏•‡∏≤ 9:00\n"
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö 3 ‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (8 ‡∏Å.‡∏û.) ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß"
    ),
}


async def ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û(service: MemoryService) -> None:
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥"""
    print("\nüíä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û...")
    for user_id, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ in ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•.items():
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False, encoding="utf-8") as f:
            f.write(‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
            path = f.name
        try:
            result = await service.memorize(resource_url=path, modality="document",
                                            where={"user_id": user_id})
            print(f"  ‚úì {user_id} ‚Äî {len(result.get('items', []))} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        finally:
            os.unlink(path)


async def ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service: MemoryService) -> None:
    """‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠"""
    print("\nüîç ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° = [
        ("‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á? ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏î?", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå"),
        ("‡∏ô‡∏±‡∏î‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£? ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå"),
        ("‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ö‡πâ‡∏≤‡∏á?", None),
    ]
    for ‡∏ñ‡∏≤‡∏°, user in ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
        where = {"user_id": user} if user else None
        print(f"\n‚ùì {‡∏ñ‡∏≤‡∏°}")
        ‡∏ú‡∏• = await service.retrieve(queries=[{"role": "user", "content": ‡∏ñ‡∏≤‡∏°}], where=where)
        for i, item in enumerate(‡∏ú‡∏•.get("items", [])[:2], 1):
            print(f"  {i}. {item.get('summary', '')[:110]}")
        if not ‡∏ú‡∏•.get("items"):
            print("  ‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")


async def ‡∏´‡∏•‡∏±‡∏Å() -> None:
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏"""
    print("=" * 55)
    print("ÔøΩÔøΩ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ‚Äî ‡∏¢‡∏≤ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£")
    print("=" * 55)
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OPENAI_API_KEY ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        return
    service = MemoryService(
        llm_profiles={"default": {"api_key": api_key, "chat_model": "gpt-4o-mini"}},
        memorize_config={"memory_categories": [
            {"name": "‡∏¢‡∏≤", "description": "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏Ç‡∏ô‡∏≤‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô"},
            {"name": "‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≠", "description": "‡∏ô‡∏±‡∏î‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤"},
            {"name": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", "description": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ"},
        ]},
    )
    print("  ‚úì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    await ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û(service)
    await ‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô(service)
    print("\n‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå")


if __name__ == "__main__":
    asyncio.run(‡∏´‡∏•‡∏±‡∏Å())
